---
title: "ebs-nbs-crab-haul"
author: "Matt Callahan-AKFIN"
date: "2/24/2022"
output: word_document
---

<br>

![](AKFIN_logo.png) 

<br>

<br>

<br>

<br>

<br>

<br>

<br>

<br>

<br>

<br>

<br>



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(flextable)
library(tidyverse)
tibble(Date=c("2/24/2022",NA, NA), 
                     Author=c("Matt Callahan","",""),
                     Comments=c("Original version","",""),
                     Version=c("1.0","",""))%>%
  flextable()%>%
  fit_to_width(max_width = 8.5)%>%
  theme_box()%>%
  bg(bg="light gray", part = "header")%>%
  width(j=c("Date", "Author", "Version"), width =1.1)%>%
  width(j="Comments", width=3)

```
\newpage


## Background 
This query provides haul and specimen level data from RACE crab surveys. It was created for James Murphy. 

## Data Sources
Separate tables exist for each crab species and Northern Bering Sea (NBS) stations are also stored in separate tables. This query unions crabhaul tables for tanner, blue king, hair, hybrid, snow, and red king crabs from the EBS and NBS. 

<br>

## Data Access URL
**Base URL:** https://apex.psmfc.org/akfin/data_marts/akmp/ebs_nbs_crab_haul

<br>


**Parameters**


```{r, echo=FALSE, message=FALSE, warning=FALSE}
tibble(Parameter=c("species_code", "min_lat", "max_lat"), 
                     Description=c("RACE species code", "Minimum latitude", "Maximum latitude"),
                     Requirement=c( "Optional", "Optional", "Optional"),
                     Values=c("69400-horsehair
68560-tanner
68590-hybrid
68580-snow
69323-blue king
69322-red king", "54-66","54-66"))%>%
  flextable()%>%
  fit_to_width(max_width = 8.5)%>%
  theme_box()%>%
  bg(bg="light gray", part = "header")%>%
  width(j=c("Parameter", "Description", "Requirement"), width =1.1)%>%
  width(j="Values", width=3)

```

<br>

**Example URLs:**

<br>

* Retrieve data for tanner crab only 
https://apex.psmfc.org/akfin/data_marts/akmp/ebs_nbs_crab_haul?species_code=68560

* Retrieve data for snow crab above 60 degrees North: https://apex.psmfc.org/akfin/data_marts/akmp/ebs_nbs_crab_haul?species_code=68580&min_lat=60

* Retrieve red and blue king crab data south of 60 degrees North:
https://apex.psmfc.org/akfin/data_marts/akmp/ebs_nbs_crab_haul?species_code=69322,69323&max_lat=60


## Data Download (R)
The full dataset is 1.16 million records and it took me 22 minutes to download. Separate downloads for each species or by region will improve download speed.

```{r eval=FALSE, message=FALSE, warning=FALSE}
#install packages if not already downloaded
library(httr) #for accessing web services
library(tidyverse) #for converting data into exportable data frame

#Modify this url as desired for a custom data query.
data<-httr::content(
  httr::GET('https://apex.psmfc.org/akfin/data_marts/akmp/ebs_nbs_crab_haul'), 
  type = "application/json") %>% 
    bind_rows

```


## Field descriptions

```{r, echo=FALSE, message=FALSE, warning=FALSE}
tibble(Parameter=c("HAULJOIN",
"VESSEL",
"CRUISE",
"HAUL",
"HAUL_TYPE",
"PERFORMANCE",
"START_DATE",
"START_HOUR",
"DURATION",
"DISTANCE_FISHED",
"NET_WIDTH",
"NET_MEASURED",
"NET_HEIGHT",
"MID_LATITUDE",
"MID_LONGITUDE",
"GIS_STATION",
"GEAR_DEPTH",
"BOTTOM_DEPTH",
"SURFACE_TEMPERATURE",
"GEAR_TEMPERATURE",
"WIRE_LENGTH",
"GEAR",
"ACCESSORIES",
"SUBSAMPLE",
"AREA_SWEPT_VARIABLE",
"SPECIES_CODE",
"SEX",
"LENGTH_WIDTH",
"SHELL_CONDITION",
"EGG_COLOR",
"EGG_CONDITION",
"CLUTCH_SIZE",
"MERUS_LENGTH",
"CHELA_HEIGHT",
"DISEASE_CODE",
"DISEASE_DORSAL",
"DISEASE_VENTRAL",
"DISEASE_LEGS",
"CALCULATED_WEIGHT",
"WEIGHT",
"SAMPLING_FACTOR"  ), 
                     Description=c("unique number generated by Oracle that identifies each haul in the table and can be used to link to other tables, such as crab and racebase.catch.",
"number assigned to each vessel participating in a NMFS survey (refer to ADP codebook)",
"six-digit number assigned to each cruise: first 4 digits identify the cruise year",
"number identifying a specific tow",
"numeric code indicating the type of haul (refer to ADP codebook)",
"numeric code indicating whether or not trawl was successful (refer to ADP codebook)",
"date trawl was set (mmddyyyy format)",
"time the trawl was set (24-hour military time format)",
"duration of tow in hours",
"distance fished, in kilometers",
"net width, in meters.  Value is calculated or determined via net mensuration equipment",
"Y (yes) if net mensuration equipment was used; N (no) if no net mensuration",
"net height, in meters",
"mid-latitude of tow",
"mid-longitude of tow",
"alphanumeric character that identifies an eastern Bering Sea crab-groundfish survey trawl location based on a 20x20 nm grid with Pribilof and St. Matthew corner stations included. ",
"depth, in meters, from net headrope to bottom",
"bottom depth, in meters",
"temperature, in degrees Celsius, of sea surface",
"temperature, in degrees Celsius, of sea bottom",
"scope, in meters",
"numeric code indicating what type of trawl was used (refer to ADP codebook)",
"numeric code indicating what type of trawl doors were used, bridle length, and other gear accessory descriptions (refer to ADP codebook)",
"numeric code indicating whether or not the catch was subsampled (refer to ADP codebook)",
"calculated as the distance fished (from the haul table, in kilometers) multiplied by the net width (from the haul table, in meters), expressed in terms of square nautical miles.  The net width (meters) is divided by 1000 to convert to kilometers, then multiplied by the distance fished.  This number is multiplied by 0.29155335 to convert from square kilometers to square nautical miles.",
"five-digit number assigned to a species (refer to species codebook)",
"one-digit numeric code assigned to a particular sex (male, female, unknown, hermaphrodite) Refer to crab codebook.",
"measurement in millimeters of king crab and hair crab species (carapace length), or Chionoecetes spp. (carapace width)",
"one-digit numeric code describing carapace condition of crab (refer to crab codebook)",
"one-digit numeric code describing color of eggs in female crabs (refer to crab codebook)",
"one-digit numeric code describing condition of eggs in female crabs (refer to crab codebook)",
"one-digit code indicating amount of eggs, if any, in female crabs (refer to crab codebook)",
"if measured, measurement in millimeters of length of second right walking leg",
"if measured, measurement in millimeters of height of right chela",
"one-digit numeric code indicating presence of black mat or bitter crab disease in crab",
"if disease present, percent of dorsal body surface covered",
"if disease present, percent of ventral body surface covered",
"if disease present, percent of surface of legs covered",
"estimated weight of individual crab using carapace size-weight parameters ",
"weight in grams of individual crab (data rarely collected)",
"indicates what percentage of the crab in a tow were measured; total number of crab in a given haul can be calculated by the formula (sum(sampling_factor))"
)
                     )%>%
  flextable()%>%
  fit_to_width(max_width = 8.5)%>%
  theme_box()%>%
  bg(bg="light gray", part = "header")%>%
   set_table_properties(layout="autofit")

```




## Source code
Below is the sql code used in the web service.

```{r eval=FALSE, message=FALSE, warning=FALSE}

select * from
(
--tanner crab
select HAULJOIN,
VESSEL,
CRUISE,
HAUL,
HAUL_TYPE,
PERFORMANCE,
START_DATE,
START_HOUR,
DURATION,
DISTANCE_FISHED,
NET_WIDTH,
NET_MEASURED,
NET_HEIGHT,
MID_LATITUDE,
MID_LONGITUDE,
GIS_STATION,
GEAR_DEPTH,
BOTTOM_DEPTH,
SURFACE_TEMPERATURE,
GEAR_TEMPERATURE,
WIRE_LENGTH,
GEAR,
ACCESSORIES,
SUBSAMPLE,
AREA_SWEPT_VARIABLE,
SPECIES_CODE,
SEX,
WIDTH as LENGTH_WIDTH,
SHELL_CONDITION,
EGG_COLOR,
EGG_CONDITION,
CLUTCH_SIZE,
MERUS_LENGTH,
CHELA_HEIGHT,
DISEASE_CODE,
DISEASE_DORSAL,
DISEASE_VENTRAL,
DISEASE_LEGS,
CALCULATED_WEIGHT,
WEIGHT,
SAMPLING_FACTOR
from ebscrab.crabhaul_bairdi
union
--blue king crab
select HAULJOIN,
VESSEL,
CRUISE,
HAUL,
HAUL_TYPE,
PERFORMANCE,
START_DATE,
START_HOUR,
DURATION,
DISTANCE_FISHED,
NET_WIDTH,
NET_MEASURED,
NET_HEIGHT,
MID_LATITUDE,
MID_LONGITUDE,
GIS_STATION,
GEAR_DEPTH,
BOTTOM_DEPTH,
SURFACE_TEMPERATURE,
GEAR_TEMPERATURE,
WIRE_LENGTH,
GEAR,
ACCESSORIES,
SUBSAMPLE,
AREA_SWEPT_VARIABLE,
SPECIES_CODE,
SEX,
LENGTH as LENGTH_WIDTH,
SHELL_CONDITION,
EGG_COLOR,
EGG_CONDITION,
CLUTCH_SIZE,
MERUS_LENGTH,
CHELA_HEIGHT,
DISEASE_CODE,
DISEASE_DORSAL,
DISEASE_VENTRAL,
DISEASE_LEGS,
CALCULATED_WEIGHT,
WEIGHT,
SAMPLING_FACTOR
from ebscrab.crabhaul_bkc
union
--hair crab
select HAULJOIN,
VESSEL,
CRUISE,
HAUL,
HAUL_TYPE,
PERFORMANCE,
START_DATE,
START_HOUR,
DURATION,
DISTANCE_FISHED,
NET_WIDTH,
NET_MEASURED,
NET_HEIGHT,
MID_LATITUDE,
MID_LONGITUDE,
GIS_STATION,
GEAR_DEPTH,
BOTTOM_DEPTH,
SURFACE_TEMPERATURE,
GEAR_TEMPERATURE,
WIRE_LENGTH,
GEAR,
ACCESSORIES,
SUBSAMPLE,
AREA_SWEPT_VARIABLE,
SPECIES_CODE,
SEX,
LENGTH as LENGTH_WIDTH,
SHELL_CONDITION,
EGG_COLOR,
EGG_CONDITION,
CLUTCH_SIZE,
MERUS_LENGTH,
CHELA_HEIGHT,
DISEASE_CODE,
DISEASE_DORSAL,
DISEASE_VENTRAL,
DISEASE_LEGS,
CALCULATED_WEIGHT,
WEIGHT,
SAMPLING_FACTOR
from ebscrab.crabhaul_ei
--hybrid
union
select HAULJOIN,
VESSEL,
CRUISE,
HAUL,
HAUL_TYPE,
PERFORMANCE,
START_DATE,
START_HOUR,
DURATION,
DISTANCE_FISHED,
NET_WIDTH,
NET_MEASURED,
NET_HEIGHT,
MID_LATITUDE,
MID_LONGITUDE,
GIS_STATION,
GEAR_DEPTH,
BOTTOM_DEPTH,
SURFACE_TEMPERATURE,
GEAR_TEMPERATURE,
WIRE_LENGTH,
GEAR,
ACCESSORIES,
SUBSAMPLE,
AREA_SWEPT_VARIABLE,
SPECIES_CODE,
SEX,
WIDTH as LENGTH_WIDTH,
SHELL_CONDITION,
EGG_COLOR,
EGG_CONDITION,
CLUTCH_SIZE,
MERUS_LENGTH,
CHELA_HEIGHT,
DISEASE_CODE,
DISEASE_DORSAL,
DISEASE_VENTRAL,
DISEASE_LEGS,
null as CALCULATED_WEIGHT,
WEIGHT,
SAMPLING_FACTOR
from ebscrab.crabhaul_hybrid
union
--snow crab
select HAULJOIN,
VESSEL,
CRUISE,
HAUL,
HAUL_TYPE,
PERFORMANCE,
START_DATE,
START_HOUR,
DURATION,
DISTANCE_FISHED,
NET_WIDTH,
NET_MEASURED,
NET_HEIGHT,
MID_LATITUDE,
MID_LONGITUDE,
GIS_STATION,
GEAR_DEPTH,
BOTTOM_DEPTH,
SURFACE_TEMPERATURE,
GEAR_TEMPERATURE,
WIRE_LENGTH,
GEAR,
ACCESSORIES,
SUBSAMPLE,
AREA_SWEPT_VARIABLE,
SPECIES_CODE,
SEX,
WIDTH as LENGTH_WIDTH,
SHELL_CONDITION,
EGG_COLOR,
EGG_CONDITION,
CLUTCH_SIZE,
MERUS_LENGTH,
CHELA_HEIGHT,
DISEASE_CODE,
DISEASE_DORSAL,
DISEASE_VENTRAL,
DISEASE_LEGS,
CALCULATED_WEIGHT,
WEIGHT,
SAMPLING_FACTOR
from ebscrab.crabhaul_opilio
union
--red king crab
select HAULJOIN,
VESSEL,
CRUISE,
HAUL,
HAUL_TYPE,
PERFORMANCE,
START_DATE,
START_HOUR,
DURATION,
DISTANCE_FISHED,
NET_WIDTH,
NET_MEASURED,
NET_HEIGHT,
MID_LATITUDE,
MID_LONGITUDE,
GIS_STATION,
GEAR_DEPTH,
BOTTOM_DEPTH,
SURFACE_TEMPERATURE,
GEAR_TEMPERATURE,
WIRE_LENGTH,
GEAR,
ACCESSORIES,
SUBSAMPLE,
AREA_SWEPT_VARIABLE,
SPECIES_CODE,
SEX,
LENGTH as LENGTH_WIDTH,
SHELL_CONDITION,
EGG_COLOR,
EGG_CONDITION,
CLUTCH_SIZE,
MERUS_LENGTH,
CHELA_HEIGHT,
DISEASE_CODE,
DISEASE_DORSAL,
DISEASE_VENTRAL,
DISEASE_LEGS,
CALCULATED_WEIGHT,
WEIGHT,
SAMPLING_FACTOR
from ebscrab.crabhaul_rkc
union
--NBS
--nbs tanner crab
select HAULJOIN,
VESSEL,
CRUISE,
HAUL,
HAUL_TYPE,
PERFORMANCE,
START_DATE,
START_HOUR,
DURATION,
DISTANCE_FISHED,
NET_WIDTH,
NET_MEASURED,
NET_HEIGHT,
MID_LATITUDE,
MID_LONGITUDE,
GIS_STATION,
GEAR_DEPTH,
BOTTOM_DEPTH,
SURFACE_TEMPERATURE,
GEAR_TEMPERATURE,
WIRE_LENGTH,
GEAR,
ACCESSORIES,
SUBSAMPLE,
AREA_SWEPT as AREA_SWEPT_VARIABLE,
SPECIES_CODE,
SEX,
WIDTH as LENGTH_WIDTH,
SHELL_CONDITION,
EGG_COLOR,
EGG_CONDITION,
CLUTCH_SIZE,
MERUS_LENGTH,
CHELA_HEIGHT,
DISEASE_CODE,
DISEASE_DORSAL,
DISEASE_VENTRAL,
DISEASE_LEGS,
CALCULATED_WEIGHT,
WEIGHT,
SAMPLING_FACTOR
from ebscrab.nbs_crabhaul_bairdi
union
--nbs blue king crab
select HAULJOIN,
VESSEL,
CRUISE,
HAUL,
HAUL_TYPE,
PERFORMANCE,
START_DATE,
START_HOUR,
DURATION,
DISTANCE_FISHED,
NET_WIDTH,
NET_MEASURED,
NET_HEIGHT,
MID_LATITUDE,
MID_LONGITUDE,
GIS_STATION,
GEAR_DEPTH,
BOTTOM_DEPTH,
SURFACE_TEMPERATURE,
GEAR_TEMPERATURE,
WIRE_LENGTH,
GEAR,
ACCESSORIES,
SUBSAMPLE,
AREA_SWEPT as AREA_SWEPT_VARIABLE,
SPECIES_CODE,
SEX,
LENGTH as LENGTH_WIDTH,
SHELL_CONDITION,
EGG_COLOR,
EGG_CONDITION,
CLUTCH_SIZE,
MERUS_LENGTH,
CHELA_HEIGHT,
DISEASE_CODE,
DISEASE_DORSAL,
DISEASE_VENTRAL,
DISEASE_LEGS,
CALCULATED_WEIGHT,
WEIGHT,
SAMPLING_FACTOR
from ebscrab.nbs_crabhaul_bkc
union
--nbs-hair crab
select HAULJOIN,
VESSEL,
CRUISE,
HAUL,
HAUL_TYPE,
PERFORMANCE,
START_DATE,
START_HOUR,
DURATION,
DISTANCE_FISHED,
NET_WIDTH,
NET_MEASURED,
NET_HEIGHT,
MID_LATITUDE,
MID_LONGITUDE,
GIS_STATION,
GEAR_DEPTH,
BOTTOM_DEPTH,
SURFACE_TEMPERATURE,
GEAR_TEMPERATURE,
WIRE_LENGTH,
GEAR,
ACCESSORIES,
SUBSAMPLE,
AREA_SWEPT as AREA_SWEPT_VARIABLE,
SPECIES_CODE,
SEX,
LENGTH as LENGTH_WIDTH,
SHELL_CONDITION,
EGG_COLOR,
EGG_CONDITION,
CLUTCH_SIZE,
MERUS_LENGTH,
CHELA_HEIGHT,
DISEASE_CODE,
DISEASE_DORSAL,
DISEASE_VENTRAL,
DISEASE_LEGS,
CALCULATED_WEIGHT,
WEIGHT,
SAMPLING_FACTOR
from ebscrab.nbs_crabhaul_ei
--nbs hybrid
union
select HAULJOIN,
VESSEL,
CRUISE,
HAUL,
HAUL_TYPE,
PERFORMANCE,
START_DATE,
START_HOUR,
DURATION,
DISTANCE_FISHED,
NET_WIDTH,
NET_MEASURED,
NET_HEIGHT,
MID_LATITUDE,
MID_LONGITUDE,
GIS_STATION,
GEAR_DEPTH,
BOTTOM_DEPTH,
SURFACE_TEMPERATURE,
GEAR_TEMPERATURE,
WIRE_LENGTH,
GEAR,
ACCESSORIES,
SUBSAMPLE,
AREA_SWEPT as AREA_SWEPT_VARIABLE,
SPECIES_CODE,
SEX,
WIDTH as LENGTH_WIDTH,
SHELL_CONDITION,
EGG_COLOR,
EGG_CONDITION,
CLUTCH_SIZE,
MERUS_LENGTH,
CHELA_HEIGHT,
DISEASE_CODE,
DISEASE_DORSAL,
DISEASE_VENTRAL,
DISEASE_LEGS,
null as CALCULATED_WEIGHT,
WEIGHT,
SAMPLING_FACTOR
from ebscrab.nbs_crabhaul_hybrid
union
--nbs snow crab
select HAULJOIN,
VESSEL,
CRUISE,
HAUL,
HAUL_TYPE,
PERFORMANCE,
START_DATE,
START_HOUR,
DURATION,
DISTANCE_FISHED,
NET_WIDTH,
NET_MEASURED,
NET_HEIGHT,
MID_LATITUDE,
MID_LONGITUDE,
GIS_STATION,
GEAR_DEPTH,
BOTTOM_DEPTH,
SURFACE_TEMPERATURE,
GEAR_TEMPERATURE,
WIRE_LENGTH,
GEAR,
ACCESSORIES,
SUBSAMPLE,
AREA_SWEPT as AREA_SWEPT_VARIABLE,
SPECIES_CODE,
SEX,
WIDTH as LENGTH_WIDTH,
SHELL_CONDITION,
EGG_COLOR,
EGG_CONDITION,
CLUTCH_SIZE,
MERUS_LENGTH,
CHELA_HEIGHT,
DISEASE_CODE,
DISEASE_DORSAL,
DISEASE_VENTRAL,
DISEASE_LEGS,
CALCULATED_WEIGHT,
WEIGHT,
SAMPLING_FACTOR
from ebscrab.nbs_crabhaul_opilio
union
--nbs red king crab
select HAULJOIN,
VESSEL,
CRUISE,
HAUL,
HAUL_TYPE,
PERFORMANCE,
START_DATE,
START_HOUR,
DURATION,
DISTANCE_FISHED,
NET_WIDTH,
NET_MEASURED,
NET_HEIGHT,
MID_LATITUDE,
MID_LONGITUDE,
GIS_STATION,
GEAR_DEPTH,
BOTTOM_DEPTH,
SURFACE_TEMPERATURE,
GEAR_TEMPERATURE,
WIRE_LENGTH,
GEAR,
ACCESSORIES,
SUBSAMPLE,
AREA_SWEPT as AREA_SWEPT_VARIABLE,
SPECIES_CODE,
SEX,
LENGTH as LENGTH_WIDTH,
SHELL_CONDITION,
EGG_COLOR,
EGG_CONDITION,
CLUTCH_SIZE,
MERUS_LENGTH,
CHELA_HEIGHT,
DISEASE_CODE,
DISEASE_DORSAL,
DISEASE_VENTRAL,
DISEASE_LEGS,
CALCULATED_WEIGHT,
WEIGHT,
SAMPLING_FACTOR
from ebscrab.nbs_crabhaul_rkc) a where
          a.species_code in (select * from table(apex_string.split(nvl(:species_code, a.species_code),','))) and
          a.mid_latitude between nvl(:min_lat, 0)and nvl(:max_lat, 90);

```
  
  
  